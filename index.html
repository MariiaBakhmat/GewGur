<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>GewGur chat</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chatBox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; background: #f9f9f9; }
    .msg { margin-bottom: 8px; }
    .user { color: blue; }
    .bot { color: green; }
    #loader { font-style: italic; color: gray; margin-bottom: 10px; display: none; }
    input, button { padding: 5px; }
  </style>
</head>
<body>

<h3>n8n Webhook Chat</h3>
<div id="chatBox"></div>
<div id="loader">...</div>

<input type="text" id="userInput" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="width: 80%;" />
<button onclick="sendMessage()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>

<script>
  const chatBox = document.getElementById("chatBox");
  const loader = document.getElementById("loader");
  const webhookUrl = "https://n8n.beinf.ai/webhook/chat";

 
  const sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
  localStorage.setItem("sessionId", sessionId);

  // –§—É–Ω–∫—Ü—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç
  function appendMessage(text, sender) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.textContent = (sender === "user" ? "üë§ " : "ü§ñ ") + text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
  window.onload = async () => {
    try {
      const res = await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          action: "getHistory"
        })
      });
      const data = await res.json();
      if (Array.isArray(data.history) && data.history.length > 0) {
        data.history.forEach(msg =>
          appendMessage(msg.text, msg.sender)
        );
      } else {
        appendMessage("Hi there! üëã My name is Taluno. How can I assist you today?", "bot");
      }
    } catch (e) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —ñ—Å—Ç–æ—Ä—ñ—ó", e);
      appendMessage("Hi there! üëã My name is Taluno. How can I assist you today?", "bot");
    }
  };


  async function sendMessage() {
    const input = document.getElementById("userInput");
    const message = input.value.trim();
    if (!message) return;

    appendMessage(message, "user");
    input.value = "";

    loader.style.display = "block";  // –ø–æ–∫–∞–∑–∞—Ç–∏ –ª–æ—É–¥–µ—Ä

    try {
      const res = await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          action: "sendMessage",
          chatInput: message
        })
      });
      const data = await res.json();
      appendMessage(data.text || "[–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ]", "bot");
    } catch (e) {
      appendMessage("[–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ]", "bot");
      console.error(e);
    } finally {
      loader.style.display = "none";  // —Å—Ö–æ–≤–∞—Ç–∏ –ª–æ—É–¥–µ—Ä
    }
  }
</script>

</body>
</html>
