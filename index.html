<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>n8n Webhook Chat</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chatBox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; background: #f9f9f9; }
    .msg { margin-bottom: 8px; }
    .user { color: blue; }
    .bot { color: green; }
    input, button { padding: 5px; }
  </style>
</head>
<body>

<h3>n8n Webhook Chat</h3>
<div id="chatBox"></div>

<input type="text" id="userInput" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="width: 80%;" />
<button onclick="sendMessage()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>

<script>
  const chatBox = document.getElementById("chatBox");


  const historyUrl = "https://n8n.beinf.ai/webhook/da1ae5d0-bfe1-4835-bb72-07f0b869ffc0";  
  const askUrl = "https://n8n.beinf.ai/webhook-test/68012dbd-61e3-47df-8cfd-1c02ebb6fff6";    

  // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π sessionId
  const sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
  localStorage.setItem("sessionId", sessionId);

  // –§—É–Ω–∫—Ü—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç
  function appendMessage(text, sender) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.textContent = (sender === "user" ? "üë§ " : "ü§ñ ") + text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
  window.onload = async () => {
    try {
      const res = await fetch(historyUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId })
      });
      const data = await res.json();
      if (Array.isArray(data.history) && data.history.length > 0) {
        data.history.forEach(msg => appendMessage(msg.text, msg.sender));
      } else {
        appendMessage("Hi there! üëã My name is Taluno. How can I assist you today?", "bot");
      }
    } catch (e) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —ñ—Å—Ç–æ—Ä—ñ—ó", e);
      appendMessage("Hi there! üëã My name is Taluno. How can I assist you today?", "bot");
    }
  };

  // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
  async function sendMessage() {
    const input = document.getElementById("userInput");
    const message = input.value.trim();
    if (!message) return;

    appendMessage(message, "user");
    input.value = "";

    try {
      // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–≥–µ–Ω—Ç—É
      const res = await fetch(askUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, chatInput: message })
      });
      const data = await res.json();
      appendMessage(data.text || "[–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ]", "bot");

      // –ü–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é
      const historyRes = await fetch(historyUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId })
      });
      const historyData = await historyRes.json();
      if (Array.isArray(historyData.history)) {
        chatBox.innerHTML = "";
        historyData.history.forEach(msg => appendMessage(msg.text, msg.sender));
      } else {
        appendMessage("[–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó]", "bot");
      }

    } catch (e) {
      appendMessage("[–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ]", "bot");
      console.error(e);
    }
  }
</script>

</body>
</html>
